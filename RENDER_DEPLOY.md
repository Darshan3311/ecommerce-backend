# Backend Deployment Guide - Render.com

## Prerequisites

1. **MongoDB Atlas Account** (Free tier available)
   - Create a cluster at [mongodb.com/cloud/atlas](https://www.mongodb.com/cloud/atlas)
   - Get connection string (e.g., `mongodb+srv://username:password@cluster.mongodb.net/ecommerce`)
   - Whitelist IP: `0.0.0.0/0` (allow from anywhere) in Network Access

2. **Cloudinary Account** (Free tier available)
   - Sign up at [cloudinary.com](https://cloudinary.com)
   - Get Cloud Name, API Key, and API Secret from dashboard

3. **Email Configuration** (Optional for email features)
   - Gmail App Password or other SMTP service
   - [Create Gmail App Password](https://support.google.com/accounts/answer/185833)

## Deployment Steps

### Option 1: Deploy via Render Dashboard (Recommended)

1. **Create New Web Service**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New" → "Web Service"
   - Connect your GitHub repository (you'll need to push backend to GitHub first)

2. **Configure Build Settings**
   - **Name:** `ecommerce-backend`
   - **Region:** Oregon (or closest to you)
   - **Branch:** `main`
   - **Root Directory:** Leave empty (if backend is at root) or specify `backend` if in monorepo
   - **Runtime:** Node
   - **Build Command:** `npm install`
   - **Start Command:** `npm start`
   - **Plan:** Free

3. **Add Environment Variables**
   
   Required variables (add in Render dashboard under "Environment"):
   
   ```
   NODE_ENV=production
   PORT=10000
   MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/ecommerce
   JWT_SECRET=<auto-generated-or-your-secret>
   JWT_EXPIRE=7d
   JWT_REFRESH_SECRET=<auto-generated-or-your-secret>
   JWT_REFRESH_EXPIRE=30d
   EMAIL_HOST=smtp.gmail.com
   EMAIL_PORT=587
   EMAIL_USER=your-email@gmail.com
   EMAIL_PASSWORD=your-app-password
   EMAIL_FROM=noreply@ecommerce.com
   CLIENT_URL=https://your-frontend-url.onrender.com
   CLOUDINARY_CLOUD_NAME=your-cloud-name
   CLOUDINARY_API_KEY=your-api-key
   CLOUDINARY_API_SECRET=your-api-secret
   FRONTEND_URL=https://your-frontend-url.onrender.com
   SESSION_SECRET=<auto-generated-or-your-secret>
   ```

4. **Deploy**
   - Click "Create Web Service"
   - Wait for deployment to complete (5-10 minutes)
   - Copy the service URL (e.g., `https://ecommerce-backend-xxxx.onrender.com`)

### Option 2: Deploy via render.yaml (Blueprint)

1. **Push backend code to GitHub**
   ```bash
   cd backend
   git init
   git add .
   git commit -m "Initial backend commit"
   git branch -M main
   git remote add origin https://github.com/Darshan3311/ecommerce-backend.git
   git push -u origin main
   ```

2. **Create New Web Service from Blueprint**
   - Go to Render Dashboard
   - Click "New" → "Blueprint"
   - Connect repository: `Darshan3311/ecommerce-backend`
   - Render will detect `render.yaml` and auto-configure
   - Add the required environment variables (see list above)
   - Deploy

## Post-Deployment

### 1. Test Backend API

```bash
# Health check
curl https://your-backend-url.onrender.com/api/health

# Test endpoints
curl https://your-backend-url.onrender.com/api/products
curl https://your-backend-url.onrender.com/api/categories
```

### 2. Seed Database (Optional)

If you need to populate initial data:

1. Go to Render Dashboard → Your Service → Shell
2. Run: `npm run seed`

Or use a one-time job:
- Create "Background Worker" or use Shell to run scripts

### 3. Update Frontend Environment Variable

In your frontend Render Static Site:
- Go to Environment Variables
- Update `REACT_APP_API_URL` with your backend URL
- Example: `https://ecommerce-backend-xxxx.onrender.com/api`
- Save and redeploy frontend

## Important Notes

### Free Tier Limitations
- **Automatic spin-down:** Service sleeps after 15 minutes of inactivity
- **Spin-up time:** 30-60 seconds on first request after sleep
- **Monthly hours:** 750 hours/month free
- **Solution:** Upgrade to paid plan or use services like [UptimeRobot](https://uptimerobot.com) to ping every 14 minutes

### CORS Configuration
Ensure your backend `server.js` allows frontend domain:
```javascript
const corsOptions = {
  origin: [
    'http://localhost:3000',
    'https://your-frontend-url.onrender.com'
  ],
  credentials: true
};
app.use(cors(corsOptions));
```

### MongoDB Atlas Whitelist
- Allow connections from anywhere: `0.0.0.0/0`
- Or add Render's IP ranges (check Render docs)

### Environment Variables Security
- Never commit `.env` files
- Use Render's environment variables feature
- Generate strong secrets for JWT_SECRET and SESSION_SECRET

## Troubleshooting

### Build Fails
- Check `package.json` has all dependencies
- Ensure Node version compatibility (check logs)
- Verify `npm install` runs successfully locally

### App Crashes on Start
- Check logs in Render Dashboard → Logs tab
- Verify all required environment variables are set
- Check MongoDB connection string is correct
- Ensure MongoDB Atlas allows connections from `0.0.0.0/0`

### 502 Bad Gateway
- Backend might be starting up (wait 30-60 seconds)
- Check if PORT environment variable is set to 10000
- Verify app listens on `0.0.0.0` not just `localhost`

### Database Connection Fails
- Verify MongoDB URI is correct
- Check MongoDB Atlas network access whitelist
- Ensure database user has correct permissions

## Monitoring

- **Logs:** Render Dashboard → Your Service → Logs
- **Metrics:** Render Dashboard → Your Service → Metrics
- **Health Check:** Set up in Render settings for auto-restart

## Backup Plan

If deployment fails, you can also try:
- **Railway.app** (similar to Render)
- **Cyclic.sh** (serverless Node.js)
- **Fly.io** (global app platform)
- **Heroku** (paid plans)

## Resources

- [Render Docs](https://render.com/docs)
- [MongoDB Atlas Setup](https://www.mongodb.com/docs/atlas/getting-started/)
- [Cloudinary Docs](https://cloudinary.com/documentation)
